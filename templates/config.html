{% extends "base.html" %}

{% block title %}Configuration - Moneybags{% endblock %}

{% block content %}
<!-- Configuration data for JavaScript -->
<div id="configPageData" data-database-configured="{{ 'true' if database_configured else 'false' }}" class="d-none"></div>
<div class="row">
    <div class="col-lg-8">
        <h2 class="mb-4">Configuration</h2>

        <div class="card mb-4">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0"><i class="bi bi-calendar-range me-2"></i>Budget Templates by Year</h5>
                <button class="btn btn-sm btn-success" id="addYearBtn">
                    <i class="bi bi-plus-circle me-1"></i>Add New Year
                </button>
            </div>
            <div class="card-body">
                <p class="text-muted mb-3">
                    Manage which categories are active for each year's budget. Only active categories appear in the budget table for that year.
                </p>
                <div class="alert alert-info py-2 px-3 mb-3 config-alert-info">
                    <strong><i class="bi bi-info-circle me-1"></i>How it works:</strong>
                    <ul class="mb-0 mt-2 config-alert-list">
                        <li>To <strong>create a budget for a year</strong>, click "Add New Year" and add categories to it.</li>
                        <li>To <strong>delete a year</strong>, remove all categories from that year. The year is automatically deleted when the last category is removed.</li>
                        <li><strong>Note:</strong> Categories with budget entries or transactions cannot be removed until that data is deleted.</li>
                    </ul>
                </div>

                <div class="accordion" id="budgetTemplatesAccordion">
                    <!-- Will be populated by JavaScript -->
                </div>

                <div id="noYearsMessage" class="text-center text-muted py-5 d-none">
                    <i class="bi bi-calendar-x no-years-icon"></i>
                    <p class="mt-3">No budget template years configured yet.<br>Click "Add New Year" to get started.</p>
                </div>
            </div>
        </div>

        <div class="card mb-4">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0"><i class="bi bi-tag me-2"></i>Categories</h5>
                <button class="btn btn-sm btn-primary" id="addCategoryBtn">
                    <i class="bi bi-plus-circle me-1"></i>Add category
                </button>
            </div>
            <div class="card-body">
                <p class="text-muted mb-3">Manage income and expense categories available across all years.</p>
                <div class="table-responsive">
                    <table class="table table-hover" id="categoriesTable">
                        <thead>
                            <tr>
                                <th>Category Name</th>
                                <th>Type</th>
                                <th>Used in Years</th>
                                <th class="text-end">Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Will be populated by JavaScript -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <div class="card mb-4">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0"><i class="bi bi-person me-2"></i>Payees</h5>
                <button class="btn btn-sm btn-primary" id="addPayeeBtn">
                    <i class="bi bi-plus-circle me-1"></i>Add payee
                </button>
            </div>
            <div class="card-body">
                <p class="text-muted mb-3">Manage payees that appear in your transactions.</p>
                <div class="mb-3">
                    <input type="text" class="form-control" id="payeeSearch" placeholder="Search payees..." autocomplete="off">
                </div>
                <div class="table-responsive">
                    <table class="table table-hover" id="payeesTable">
                        <thead>
                            <tr>
                                <th>Payee Name</th>
                                <th># Transactions</th>
                                <th>Last Used</th>
                                <th class="text-end">Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Will be populated by JavaScript -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0"><i class="bi bi-currency-dollar me-2"></i>Currency Settings</h5>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <label for="currencyFormat" class="form-label">Currency Format</label>
                    <select class="form-select" id="currencyFormat">
                        <option value="" selected>Not selected</option>
                        <option value="nok">NOK (kr)</option>
                        <option value="usd">USD ($)</option>
                        <option value="eur">EUR (â‚¬)</option>
                    </select>
                    <div class="form-text">Select the currency format to display amounts throughout the application.</div>
                </div>
                <button class="btn btn-primary" id="saveCurrencyBtn" disabled>
                    <i class="bi bi-save me-1"></i>Save Currency Settings
                </button>
            </div>
        </div>

        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0"><i class="bi bi-database me-2"></i>Database Connection</h5>
            </div>
            <div class="card-body">
                <p class="text-muted mb-3">Configure MariaDB database connection settings.</p>

                <div class="alert alert-warning" role="alert">
                    <i class="bi bi-exclamation-triangle me-2"></i>
                    <strong>Note:</strong> Changing these settings requires application restart.
                </div>

                <div id="connectionStatus" class="alert d-none" role="alert"></div>

                <form id="dbConnectionForm">
                    <div class="row">
                        <div class="col-md-8 mb-3">
                            <label for="dbHost" class="form-label">Database Host</label>
                            <input type="text" class="form-control" id="dbHost" placeholder="localhost or mariadb" value="localhost" autocomplete="url">
                        </div>
                        <div class="col-md-4 mb-3">
                            <label for="dbPort" class="form-label">Port</label>
                            <input type="number" class="form-control" id="dbPort" value="3306" autocomplete="off">
                        </div>
                    </div>

                    <div class="mb-3">
                        <label for="dbName" class="form-label">Database Name</label>
                        <input type="text" class="form-control" id="dbName" value="moneybags" autocomplete="off">
                    </div>

                    <div class="mb-3">
                        <label for="dbUser" class="form-label">Database User</label>
                        <input type="text" class="form-control" id="dbUser" value="moneybags_user" autocomplete="username">
                    </div>

                    <div class="mb-3">
                        <label for="dbPassword" class="form-label">Database Password</label>
                        <input type="password" class="form-control" id="dbPassword" placeholder="Enter password" autocomplete="current-password">
                    </div>

                    <div class="mb-3">
                        <label for="dbPoolSize" class="form-label">Connection Pool Size</label>
                        <input type="number" class="form-control" id="dbPoolSize" value="10" min="1" max="50" autocomplete="off">
                        <div class="form-text">Number of connections to maintain in pool (default: 10)</div>
                    </div>

                    <div class="d-flex gap-2">
                        <button type="button" class="btn btn-outline-primary" id="testDbConnectionBtn">
                            <i class="bi bi-check-circle me-1"></i>Test Connection
                        </button>
                        <button type="button" class="btn btn-primary" id="saveDbConnectionBtn">
                            <i class="bi bi-save me-1"></i>Save Settings
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Category Modal -->
<div class="modal fade" id="categoryModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="categoryModalTitle">Add Category</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="categoryForm">
                    <div class="mb-3">
                        <label for="categoryName" class="form-label">Category Name</label>
                        <input type="text" class="form-control" id="categoryName" required autocomplete="off">
                    </div>
                    <div class="mb-3">
                        <label for="categoryType" class="form-label">Type</label>
                        <select class="form-select" id="categoryType" required>
                            <option value="">Select type...</option>
                            <option value="income">Income</option>
                            <option value="expenses">Expenses</option>
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="saveCategoryModalBtn">Save</button>
            </div>
        </div>
    </div>
</div>

<!-- Payee Modal -->
<div class="modal fade" id="payeeModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="payeeModalTitle">Add Payee</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="payeeForm">
                    <div class="mb-3">
                        <label for="payeeName" class="form-label">Payee Name</label>
                        <input type="text" class="form-control" id="payeeName" required autocomplete="off">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="savePayeeModalBtn">Save</button>
            </div>
        </div>
    </div>
</div>

<!-- Add Year Modal -->
<div class="modal fade" id="addYearModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Add New Budget Year</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="addYearForm">
                    <div class="mb-3">
                        <label for="newYear" class="form-label">Year</label>
                        <input type="number" class="form-control" id="newYear" min="2000" max="2100" required autocomplete="off">
                    </div>
                    <div class="mb-3">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="copyFromPreviousYear" checked>
                            <label class="form-check-label" for="copyFromPreviousYear">
                                Copy categories from previous year
                            </label>
                        </div>
                        <div class="form-text">If checked, all categories from the most recent year will be copied to the new year</div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-success" id="saveNewYearBtn">Create Year</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}
